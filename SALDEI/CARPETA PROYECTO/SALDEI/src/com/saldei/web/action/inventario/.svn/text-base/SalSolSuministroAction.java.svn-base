/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.saldei.web.action.inventario;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionError;
import org.apache.struts.action.ActionErrors;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.actions.LookupDispatchAction;

import com.saldei.hibernate.tables.Usuario;
import com.saldei.hibernate.tables.activos.ActDetSolicitudDAO;
import com.saldei.hibernate.tables.activos.ActSolicitudDAO;
import com.saldei.hibernate.tables.activos.ActSolicitudId;
import com.saldei.hibernate.tables.inventario.InvBodega;
import com.saldei.hibernate.tables.inventario.InvDetMovimiento;
import com.saldei.hibernate.tables.inventario.InvDetMovimientoDAO;
import com.saldei.hibernate.tables.inventario.InvDetMovimientoId;
import com.saldei.hibernate.tables.inventario.InvMovimiento;
import com.saldei.hibernate.tables.inventario.InvMovimientoDAO;
import com.saldei.hibernate.tables.inventario.InvMovimientoId;
import com.saldei.hibernate.tables.inventario.InvRecurso;
import com.saldei.hibernate.tables.inventario.InvTipoMov;
import com.saldei.util.hibernate.dao.HibernateSessionFactory;
import com.saldei.web.bean.seguridad.UsuarioDto;
import com.saldei.web.form.inventario.IngAbasSuministroForm;
import com.saldei.web.form.inventario.SalSolSuministroForm;
import com.saldei.web.services.seguridad.UsuarioServices;

/** 
 * MyEclipse Struts
 * Creation date: 08-06-2009
 * 
 * XDoclet definition:
 * @struts.action path="/salSolSuministroAction" name="salSolSuministroForm" input="/html/inventario/salSolSuministro.jsp" parameter="accion" scope="request"
 * @struts.action-forward name="updateFail" path="/html/inventario/salSolSuministro.jsp"
 * @struts.action-forward name="success" path="/html/inventario/salSolSuministro.jsp?accion="
 */
public class SalSolSuministroAction extends LookupDispatchAction {
	/*
	 * Generated Methods
	 */
	
	@Override
	protected Map getKeyMethodMap() {
        HashMap map = new HashMap();
        
		map.put("opc.find", "aprobadas");
        map.put("opc.insert", "insert");                        
        map.put("opc.enviarSolicitud", "enviar");
        map.put("opc.cancel", "enviar");
        map.put("opc.back", "aprobadas");
        
        return map;
  }

	/** 
	 * Method Aprobadas: busca todas las solicitudes con estado aprobadas para mostrarse en la pantalla de Salidas
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward aprobadas(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		
		HttpSession session = request.getSession(true);
		String target = "ingresar";
		String user;
		List data;
		SalSolSuministroForm salSolSuministroForm =  (SalSolSuministroForm) form;// TODO Auto-generated method stub
		ActSolicitudDAO actSolicitudDAO = new ActSolicitudDAO();
		
		
		try {
			user =  (String) session.getAttribute("user");
			if(salSolSuministroForm.getMostrarHistorico()!=null && salSolSuministroForm.getMostrarHistorico().equals("S"))
				data = actSolicitudDAO.findAllSolicutudSuministroAprobadas(user,"S");
			else
				data = actSolicitudDAO.findAllSolicutudSuministroAprobadas(user,"N");
			//data = actSolicitudDAO.findAllSolicutudSuministroAprobadas(user);
		    request.setAttribute("listSolSuministroAprobadas", data);						
			
		} catch (Exception e) {
			e.printStackTrace();			
			// TODO: handle exception
		}finally{
			HibernateSessionFactory.getSession().close();
		} 	
		return mapping.findForward(target);
	}
	
	@SuppressWarnings("unchecked")
	public ActionForward enviar(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		
		String target = "success";
		List data;
		SalSolSuministroForm salSolSuministroForm = (SalSolSuministroForm) form;// TODO Auto-generated method stub
		ActSolicitudDAO actSolicitudDAO = new ActSolicitudDAO();
		UsuarioDto usuarioDto;
		UsuarioServices usuarioServices = new UsuarioServices();
		ActDetSolicitudDAO actDetSolicitudDAO = new ActDetSolicitudDAO();
		
				
		try {
			salSolSuministroForm.setActSolicitud(actSolicitudDAO.findById(new ActSolicitudId(salSolSuministroForm.getTipoSolicitud(),salSolSuministroForm.getCodSolicitud())));
			data = actDetSolicitudDAO.findBySolicitud(salSolSuministroForm.getTipoSolicitud(), salSolSuministroForm.getActSolicitud().getId().getCodSolicitud());
			usuarioDto = usuarioServices.getUsuarioDto(salSolSuministroForm.getActSolicitud().getCodSolicitante());
			salSolSuministroForm.setSolicitante(usuarioDto.getPrimerNom()+" "+usuarioDto.getPrimerApe());
					
			
			request.setAttribute("listSolDet", data);
		
		} catch (Exception e) {
			e.printStackTrace();			
			// TODO: handle exception
		}finally{
			HibernateSessionFactory.getSession().close();
		} 	
		return mapping.findForward(target);
	}
	
	@SuppressWarnings("unchecked")
	public ActionForward insert(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		
		
		String target = "success";
		Integer codTipoMovimiento = 3;
		
		SalSolSuministroForm salSolSuministroForm = (SalSolSuministroForm) form;// TODO Auto-generated method stub
		ActSolicitudDAO actSolicitudDAO = new ActSolicitudDAO();		
		InvMovimientoDAO invMovimientoDAO = new InvMovimientoDAO();
		InvMovimiento invMovimiento =  new InvMovimiento();
		InvMovimiento invMovimientoNew =  new InvMovimiento();
		InvDetMovimientoDAO invDetMovimientoDAO = new InvDetMovimientoDAO();		
		InvBodega bodega = new InvBodega();
		ActionErrors errors =  new ActionErrors();
		int flagMovimiento = 0;
		int flagExistencias = 0;
		int flagCompletado = 1;
				
		try {
			
			salSolSuministroForm.validate(mapping, request, errors);
			
			if(errors.isEmpty()){
			
				/* se setean los valores para ingresar un movimiento*/
				salSolSuministroForm.setActSolicitud(actSolicitudDAO.findById(new ActSolicitudId(salSolSuministroForm.getTipoSolicitud(),Integer.valueOf(salSolSuministroForm.getCodSolicitud()))));
				bodega.setCodBodega(salSolSuministroForm.getActSolicitud().getCodBodega());
				invMovimiento.setInvBodega(bodega);
				invMovimiento.setCodSol(salSolSuministroForm.getCodSolicitud());
				invMovimiento.setTipoSol(salSolSuministroForm.getTipoSolicitud());			
				invMovimiento.setInvTipoMov(new InvTipoMov(codTipoMovimiento));
				invMovimiento.setId(new InvMovimientoId(0,0));
				Usuario user = (Usuario)request.getSession().getAttribute("usuario");
				
				/* se ingresa el movimiento*/
				invMovimientoDAO.save(invMovimiento,user.getIdUsuario());
				
				invMovimientoNew = invMovimientoDAO.findBySolicitud(salSolSuministroForm.getTipoSolicitud(),salSolSuministroForm.getCodSolicitud());
				
				for(int i=0;i < salSolSuministroForm.getCantidadIngresar().length;i++){
					int entregado;
					int cantidad;
					double existencia;
					int cantidadIngresar;
					InvDetMovimiento invDetMovimiento =  new InvDetMovimiento();
					String datos = salSolSuministroForm.getCantidadIngresar()[i];
					String[] valores = datos.split(",");	
					entregado = (valores.length > 3)?Integer.valueOf(valores[3]):0;
					cantidad = Integer.valueOf(valores[1]);
					existencia = Double.valueOf(valores[2]);
					cantidadIngresar = cantidad - entregado;
					if(existencia < cantidadIngresar){
						cantidadIngresar = (int) existencia;
					}
					InvRecurso invRecurso =  new InvRecurso();
					/* se setean los valores para ingresar un detalle de movimiento*/
					invRecurso.setCodRecurso(valores[0]);
					invDetMovimiento.setCantidad(cantidadIngresar);
					invDetMovimiento.setId(new InvDetMovimientoId(invMovimientoNew, invRecurso ));
					
					/* se ingresa el detalle de  movimiento*/					
					if(cantidadIngresar != 0){
						invDetMovimientoDAO.save(invDetMovimiento,user.getIdUsuario());
						flagMovimiento = 1;
						
					}else if(existencia == 0){
						flagExistencias = 2;
					}
					
					if(cantidadIngresar+entregado != Integer.valueOf(valores[1])){
						flagCompletado = 0;
					}
						
				}
				
				if(flagCompletado == 1){
					salSolSuministroForm.getActSolicitud().setEstado("F");
					actSolicitudDAO.merge(salSolSuministroForm.getActSolicitud());					
				}
							
				if(flagMovimiento == 1){
					HibernateSessionFactory.getSession().beginTransaction().commit();
					errors.add("salSolSuministro.mensaje.exito", new ActionError("salSolSuministro.mensaje.exito.ingreso"));
				}else
				if(flagExistencias == 2){
					HibernateSessionFactory.getSession().beginTransaction().rollback();
					errors.add("salSolSuministro.mensaje.fallo", new ActionError("salSolSuministro.mensaje.fallo.existencia"));
				}else{
					HibernateSessionFactory.getSession().beginTransaction().rollback();
					errors.add("salSolSuministro.mensaje.fallo", new ActionError("salSolSuministro.mensaje.fallo"));
				}
				
			}
			
		} catch (Exception e) {
			e.printStackTrace();			
			HibernateSessionFactory.getSession().beginTransaction().rollback();
			// TODO: handle exception
		}finally{
			HibernateSessionFactory.getSession().close();
			if(!errors.isEmpty()){
				saveErrors(request, errors);
			}
		} 	
		this.enviar(mapping, form, request, response);
		return mapping.findForward(target);
	}
	
}