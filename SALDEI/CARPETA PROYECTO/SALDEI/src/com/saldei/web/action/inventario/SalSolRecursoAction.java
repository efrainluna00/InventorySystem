/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.saldei.web.action.inventario;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionError;
import org.apache.struts.action.ActionErrors;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.actions.LookupDispatchAction;

import com.saldei.hibernate.tables.Usuario;
import com.saldei.hibernate.tables.activos.ActActivoDAO;
import com.saldei.hibernate.tables.activos.ActCotizacion;
import com.saldei.hibernate.tables.activos.ActCotizacionDAO;
import com.saldei.hibernate.tables.activos.ActDetSolicitudDAO;
import com.saldei.hibernate.tables.activos.ActSolicitudDAO;
import com.saldei.hibernate.tables.activos.ActSolicitudId;
import com.saldei.hibernate.tables.inventario.InvBodega;
import com.saldei.hibernate.tables.inventario.InvDetMovActivo;
import com.saldei.hibernate.tables.inventario.InvDetMovActivoDAO;
import com.saldei.hibernate.tables.inventario.InvDetMovimiento;
import com.saldei.hibernate.tables.inventario.InvDetMovimientoDAO;
import com.saldei.hibernate.tables.inventario.InvDetMovimientoId;
import com.saldei.hibernate.tables.inventario.InvMovimiento;
import com.saldei.hibernate.tables.inventario.InvMovimientoDAO;
import com.saldei.hibernate.tables.inventario.InvMovimientoId;
import com.saldei.hibernate.tables.inventario.InvRecurso;
import com.saldei.hibernate.tables.inventario.InvTipoMov;
import com.saldei.util.hibernate.dao.HibernateSessionFactory;
import com.saldei.web.bean.seguridad.UsuarioDto;
import com.saldei.web.form.inventario.IngAbasSuministroForm;
import com.saldei.web.form.inventario.SalSolRecursoForm;
import com.saldei.web.form.inventario.SalSolSuministroForm;
import com.saldei.web.services.seguridad.UsuarioServices;

/** 
 * MyEclipse Struts
 * Creation date: 08-08-2009
 * 
 * XDoclet definition:
 * @struts.action path="/salSolRecursoAction" name="salSolRecursoForm" input="/html/inventario/salSolRecurso.jsp" parameter="accion" scope="request"
 * @struts.action-forward name="updateFail" path="/html/inventario/salSolRecurso.jsp"
 * @struts.action-forward name="succees" path="/html/inventario/salSolRecurso.jsp?accion="
 */
public class SalSolRecursoAction extends LookupDispatchAction {
	/*
	 * Generated Methods
	 */

	@Override
	protected Map getKeyMethodMap() {
        HashMap map = new HashMap();
        
		map.put("opc.find", "aprobadas");
        map.put("opc.insert", "insert");                        
        map.put("opc.enviarSolicitud", "enviar");
        map.put("opc.cancel", "enviar");
        map.put("opc.back", "aprobadas");
        
        return map;
  }
	
	
	/** 
	 * Method Aprobadas: busca todas las solicitudes con estado aprobadas para mostrarse en la pantalla de Salidas
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward aprobadas(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		
		HttpSession session = request.getSession(true);
		String target = "ingresar";
		String user;
		List data, data2;
		SalSolRecursoForm salSolRecursoForm =  (SalSolRecursoForm) form;// TODO Auto-generated method stub
		ActSolicitudDAO actSolicitudDAO = new ActSolicitudDAO();
		
		
		try {
			user =  (String) session.getAttribute("user");
			
				if(salSolRecursoForm.getMostrarHistorico()!=null && salSolRecursoForm.getMostrarHistorico().equals("S")){
					data = actSolicitudDAO.findAllSolicutudReq(user,"S");
					data2 = actSolicitudDAO.findAllSolicutudCom(user,"S");
					for (int i=0; i < data2.size(); i++){
						data.add(data2.get(i));
					}
				}					
				else{
					data = actSolicitudDAO.findAllSolicutudReq(user,"N");
					data2 = actSolicitudDAO.findAllSolicutudCom(user,"N");
					for (int i=0; i < data2.size(); i++){
						data.add(data2.get(i));
					}
				}											
			
			//data = actSolicitudDAO.findAllSolicutudRecurso(user);
		    request.setAttribute("listSolRecursosAprobadas", data);						
			
		} catch (Exception e) {
			e.printStackTrace();			
			// TODO: handle exception
		}finally{
			HibernateSessionFactory.getSession().close();
		} 	
		return mapping.findForward(target);
	}
	
	
	@SuppressWarnings("unchecked")
	public ActionForward enviar(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		
		String target = "success";
		List data;
		SalSolRecursoForm salSolRecursoForm = (SalSolRecursoForm) form;// TODO Auto-generated method stub
		ActSolicitudDAO actSolicitudDAO = new ActSolicitudDAO();
		UsuarioDto usuarioDto;
		UsuarioServices usuarioServices = new UsuarioServices();
		ActDetSolicitudDAO actDetSolicitudDAO = new ActDetSolicitudDAO();
		ActCotizacion actCotizacion;
		ActCotizacionDAO actCotizacionDAO = new ActCotizacionDAO();
		
				
		try {
			salSolRecursoForm.setActSolicitud(actSolicitudDAO.findById(new ActSolicitudId(salSolRecursoForm.getTipoSolicitud(),salSolRecursoForm.getCodSolicitud())));
						
			usuarioDto = usuarioServices.getUsuarioDto(salSolRecursoForm.getActSolicitud().getCodSolicitante());
			salSolRecursoForm.setSolicitante(usuarioDto.getPrimerNom()+" "+usuarioDto.getPrimerApe());
					
			if(salSolRecursoForm.getActSolicitud().getId().getTipoSolicitud().equals("C")){
				actCotizacion = actCotizacionDAO.findByEstado(salSolRecursoForm.getTipoSolicitud(),String.valueOf(salSolRecursoForm.getCodSolicitud()));
				request.setAttribute("listSolDet",  actCotizacion.getActDetCotizacions());
			}else{
				data = actDetSolicitudDAO.findBySolicitud(salSolRecursoForm.getTipoSolicitud(), salSolRecursoForm.getActSolicitud().getId().getCodSolicitud());
				request.setAttribute("listSolDet", data);
			}
				
		
		} catch (Exception e) {
			e.printStackTrace();			
			// TODO: handle exception
		}finally{
			HibernateSessionFactory.getSession().close();
		} 	
		return mapping.findForward(target);
	}
	
	
	@SuppressWarnings("unchecked")
	public ActionForward insert(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		SalSolRecursoForm salSolRecursoForm = (SalSolRecursoForm) form;// TODO Auto-generated method stub
		try {
			if (salSolRecursoForm.getTipoSolicitud().equals("C")) {
				return this.insertSol(mapping, form, request, response);
			} else {
				return this.insertReq(mapping, form, request, response);
			}
		} catch (Exception e) {
			// TODO: handle exception
		}
		
		return this.enviar(mapping, form, request, response);
	}
	
	
	@SuppressWarnings("unchecked")
	public ActionForward insertSol(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		
		
		String target = "success";
		// codigo de tipo de movimiento de requisicion de recurso
		Integer codTipoMovimiento = 4;
		
		SalSolRecursoForm salSolRecursoForm = (SalSolRecursoForm) form;// TODO Auto-generated method stub
		ActSolicitudDAO actSolicitudDAO = new ActSolicitudDAO();		
		InvMovimientoDAO invMovimientoDAO = new InvMovimientoDAO();
		InvMovimiento invMovimiento =  new InvMovimiento();
		InvMovimiento invMovimientoNew =  new InvMovimiento();
		InvDetMovimientoDAO invDetMovimientoDAO = new InvDetMovimientoDAO();
		ActActivoDAO actActivoDAO =  new ActActivoDAO();
		InvBodega bodega = new InvBodega();
		InvDetMovActivo invDetMovActivo = new InvDetMovActivo();
		InvDetMovActivoDAO invDetMovActivoDAO = new InvDetMovActivoDAO();
		ActionErrors errors =  new ActionErrors();
		int flagMovimiento = 0;
		int flagExistencias = 0;
		int flagCompletado = 1;
				
		try {
			
			salSolRecursoForm.validate(mapping, request, errors);
			
			if(errors.isEmpty()){
			
				/* se setean los valores para ingresar un movimiento*/
				salSolRecursoForm.setActSolicitud(actSolicitudDAO.findById(new ActSolicitudId(salSolRecursoForm.getTipoSolicitud(),Integer.valueOf(salSolRecursoForm.getCodSolicitud()))));
				bodega.setCodBodega(salSolRecursoForm.getActSolicitud().getCodBodega());
				invMovimiento.setInvBodega(bodega);
				invMovimiento.setCodSol(salSolRecursoForm.getCodSolicitud());
				invMovimiento.setTipoSol(salSolRecursoForm.getTipoSolicitud());			
				invMovimiento.setInvTipoMov(new InvTipoMov(codTipoMovimiento));
				invMovimiento.setId(new InvMovimientoId(0,0));
				Usuario user = (Usuario)request.getSession().getAttribute("usuario");
				
				/* se ingresa el movimiento*/
				invMovimientoDAO.save(invMovimiento,user.getIdUsuario());
				
				invMovimientoNew = invMovimientoDAO.findBySolicitud(salSolRecursoForm.getTipoSolicitud(),salSolRecursoForm.getCodSolicitud());
				
				for(int i=0;i < salSolRecursoForm.getCantidadIngresar().length;i++){
					int entregado;
					int cantidad;
					double existencia;
					int cantidadIngresar;
					InvDetMovimiento invDetMovimiento =  new InvDetMovimiento();
					String datos = salSolRecursoForm.getCantidadIngresar()[i];
					String[] valores = datos.split(",");	
					entregado = (valores.length > 3)?Integer.valueOf(valores[3]):0;
					cantidad = Integer.valueOf(valores[1]);
					existencia = Double.valueOf(valores[2]);
					cantidadIngresar = cantidad - entregado;
					if(existencia < cantidadIngresar){
						cantidadIngresar = (int) existencia;
					}
					InvRecurso invRecurso =  new InvRecurso();
					/* se setean los valores para ingresar un detalle de movimiento*/
					invRecurso.setCodRecurso(valores[0]);
					invDetMovimiento.setCantidad(cantidadIngresar);
					invDetMovimiento.setId(new InvDetMovimientoId(invMovimientoNew, invRecurso ));
					
					/* se ingresa el detalle de  movimiento*/					
					if(cantidadIngresar != 0){
						invDetMovimientoDAO.save(invDetMovimiento,user.getIdUsuario());
						
						actActivoDAO.updateMovActivosBySolicitud(salSolRecursoForm.getTipoSolicitud(),Integer.valueOf(salSolRecursoForm.getCodSolicitud())
								, salSolRecursoForm.getActSolicitud().getActUnidad().getCodUnidad(), invRecurso.getCodRecurso(), invDetMovimiento);
												
						flagMovimiento = 1;
					
					}else if(existencia == 0){
						flagExistencias = 1;
					}
					
					if(cantidadIngresar+entregado != Integer.valueOf(valores[1])){
						flagCompletado = 0;
					}
						
				}
				
				if(flagCompletado == 1){
					salSolRecursoForm.getActSolicitud().setEstado("F");
					actSolicitudDAO.merge(salSolRecursoForm.getActSolicitud());					
				}
				
				if(flagMovimiento == 1){					
					HibernateSessionFactory.getSession().beginTransaction().commit();
					errors.add("salSolRecurso.mensaje.exito", new ActionError("salSolRecurso.mensaje.exito.ingreso"));
				}else
				if(flagMovimiento == 0 && flagExistencias == 1){
					HibernateSessionFactory.getSession().beginTransaction().rollback();
					errors.add("salSolRecurso.mensaje.fallo", new ActionError("salSolRecurso.mensaje.fallo.existencia"));
				}else{
					HibernateSessionFactory.getSession().beginTransaction().rollback();
					errors.add("salSolRecurso.mensaje.fallo", new ActionError("salSolRecurso.mensaje.fallo"));
				}
				
			}
			
		} catch (Exception e) {
			e.printStackTrace();			
			HibernateSessionFactory.getSession().beginTransaction().rollback();
			// TODO: handle exception
		}finally{
			HibernateSessionFactory.getSession().close();
			if(!errors.isEmpty()){
				saveErrors(request, errors);
			}
		} 	
		this.enviar(mapping, form, request, response);
		return mapping.findForward(target);
	}
	
	
	@SuppressWarnings("unchecked")
	public ActionForward insertReq(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		
		
		String target = "success";
		HttpSession session = request.getSession(true);
		String usuario = (String) session.getAttribute("user");
		// codigo de tipo de movimiento de requisicion de recurso
		Integer codTipoMovimiento = 4;
		
		SalSolRecursoForm salSolRecursoForm = (SalSolRecursoForm) form;// TODO Auto-generated method stub
		ActSolicitudDAO actSolicitudDAO = new ActSolicitudDAO();		
		InvMovimientoDAO invMovimientoDAO = new InvMovimientoDAO();
		InvMovimiento invMovimiento =  new InvMovimiento();
		InvMovimiento invMovimientoNew =  new InvMovimiento();
		InvDetMovimientoDAO invDetMovimientoDAO = new InvDetMovimientoDAO();
		ActActivoDAO actActivoDAO =  new ActActivoDAO();
		InvBodega bodega = new InvBodega();
		InvDetMovActivo invDetMovActivo = new InvDetMovActivo();
		InvDetMovActivoDAO invDetMovActivoDAO = new InvDetMovActivoDAO();
		ActionErrors errors =  new ActionErrors();
		int flagMovimiento = 0;
		int flagExistencias = 0;
		int flagCompletado = 1;
				
		try {
			
			salSolRecursoForm.validate(mapping, request, errors);
			
			if(errors.isEmpty()){
			
				/* se setean los valores para ingresar un movimiento*/
				salSolRecursoForm.setActSolicitud(actSolicitudDAO.findById(new ActSolicitudId(salSolRecursoForm.getTipoSolicitud(),Integer.valueOf(salSolRecursoForm.getCodSolicitud()))));
				bodega.setCodBodega(salSolRecursoForm.getActSolicitud().getCodBodega());
				invMovimiento.setInvBodega(bodega);
				invMovimiento.setCodSol(salSolRecursoForm.getCodSolicitud());
				invMovimiento.setTipoSol(salSolRecursoForm.getTipoSolicitud());			
				invMovimiento.setInvTipoMov(new InvTipoMov(codTipoMovimiento));
				invMovimiento.setId(new InvMovimientoId(0,0));
				
				
				/* se ingresa el movimiento*/
				invMovimientoDAO.save(invMovimiento,usuario);
				
				invMovimientoNew = invMovimientoDAO.findBySolicitud(salSolRecursoForm.getTipoSolicitud(),salSolRecursoForm.getCodSolicitud());
				
				for(int i=0;i < salSolRecursoForm.getCantidadIngresar().length;i++){
					int entregado;
					int cantidad;
					double existencia;
					int cantidadIngresar;
					InvDetMovimiento invDetMovimiento =  new InvDetMovimiento();
					String datos = salSolRecursoForm.getCantidadIngresar()[i];
					String[] valores = datos.split(",");	
					entregado = (valores.length > 3)?Integer.valueOf(valores[3]):0;
					cantidad = Integer.valueOf(valores[1]);
					existencia = Double.valueOf(valores[2]);
					cantidadIngresar = cantidad - entregado;
					if(existencia < cantidadIngresar){
						cantidadIngresar = (int) existencia;
					}
					InvRecurso invRecurso =  new InvRecurso();
					/* se setean los valores para ingresar un detalle de movimiento*/
					invRecurso.setCodRecurso(valores[0]);
					invDetMovimiento.setCantidad(cantidadIngresar);
					invDetMovimiento.setId(new InvDetMovimientoId(invMovimientoNew, invRecurso ));
					
					/* se ingresa el detalle de  movimiento*/					
					if(cantidadIngresar != 0){
						invDetMovimientoDAO.save(invDetMovimiento,usuario);
						
						for(int m = 0; m < salSolRecursoForm.getSeriesIngresar().length;m++){
							String datosSeries = salSolRecursoForm.getSeriesIngresar()[m];
							int indiceInicial = datosSeries.indexOf(",");
							String codRecurso = datosSeries.substring(0,indiceInicial);
							datosSeries = datosSeries.substring(indiceInicial+1);							
							if(codRecurso.equals(invRecurso.getCodRecurso()))
								actActivoDAO.updateMovActivosByReq(salSolRecursoForm.getActSolicitud().getActUnidad().getCodUnidad(), invDetMovimiento, datosSeries);
							
							flagMovimiento = 1;
							
						}
						
						
					}else if(existencia == 0){
						flagExistencias = 1;
					}
					
					if(cantidadIngresar+entregado != Integer.valueOf(valores[1])){
						flagCompletado = 0;
					}
						
				}
				
				if(flagCompletado == 1){
					salSolRecursoForm.getActSolicitud().setEstado("F");
					actSolicitudDAO.merge(salSolRecursoForm.getActSolicitud());
				}
							
				if(flagMovimiento == 1){					
					HibernateSessionFactory.getSession().beginTransaction().commit();
					errors.add("salSolRecurso.mensaje.exito", new ActionError("salSolRecurso.mensaje.exito.ingreso"));
				}else
				if(flagMovimiento == 0 && flagExistencias == 1){
					HibernateSessionFactory.getSession().beginTransaction().rollback();
					errors.add("salSolRecurso.mensaje.fallo", new ActionError("salSolRecurso.mensaje.fallo.existencia"));
				}else{
					HibernateSessionFactory.getSession().beginTransaction().rollback();
					errors.add("salSolRecurso.mensaje.fallo", new ActionError("salSolRecurso.mensaje.fallo"));
				}
				
			}
			
		} catch (Exception e) {
			e.printStackTrace();			
			HibernateSessionFactory.getSession().beginTransaction().rollback();
			// TODO: handle exception
		}finally{
			HibernateSessionFactory.getSession().close();
			if(!errors.isEmpty()){
				saveErrors(request, errors);
			}
		} 	
		this.enviar(mapping, form, request, response);
		return mapping.findForward(target);
	}
	
	
}